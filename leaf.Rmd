# Leaf {#cha:leaf}


```{r setup_leaf, message=FALSE, echo=FALSE, warning=FALSE}
library(knitr)
opts_chunk$set(
    cache = FALSE, echo = FALSE, 
    out.width = '80%', fig.asp = 1.2,
    warning = FALSE, fig.align = 'center',
    message = FALSE) 
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(xml2)
library(DiagrammeR)
source('_utility.R')
report <- read_csv('simulation/simulation.db.Report.csv')

df <- report 
pmf <- read_xml('simulation/simulation.apsimx')


x_var <- c(
    'Wheat.Phenology.Stage',
    'Wheat.Phenology.AccumulateThermalTime')
x_lab <- 'Accumulated thermal time, stage'
```



Leaf cohort model is used in the APSIM-Wheat.

## Life growth cycle

The growth cycle of leaf cohort is divided into 7 stages and 6 periods from `Initialized` to `Detached`. The length of each period depends on the `plastrochron` and `phylochron` for initialization and appearance and is configured by `CohortParameters` for others.

Several status variables are defined for each leaf cohort, which can be used in other modules to describe the current status of leaf cohort, i.e. `IsNotAppeared`, `IsGrowing`, `IsAlive`, `IsGreen`, `IsNotSenescing`, `Senescing`, `isFullyExpanded`, `ShouldBeDead`, `IsAppeared` and `IsInitialised`. 

<div class="fig-input">
```{r leaf-life-cycle, out.width='95%', fig.asp=0.7, fig.cap='The life cycle of a leaf cohort.'}

DiagrammeR("sequenceDiagram;
	Initialized->>Appeared: Appearance 
	Appeared->>Expanded: GrowthDuration
	Expanded->>Senescing: LagDuration
	Senescing->>Senesced: SenescenceDuration
	Senesced->>Detaching: DetachmentLagDuration
	Detaching->>Detached: DetachmentDuration
    Initialized->Appeared: IsNotAppeared
    Initialized->Expanded: IsGrowing
	Initialized->>Senesced: IsAlive
	Initialized->>Senesced: IsGreen
	Initialized->>Senescing: IsNotSenescing
	Senescing->>Senesced: IsSenescing
	Expanded->>Detached: IsFullyExpanded
	Senesced->>Detached: ShouldBeDead
	Senesced->>Detached: Finished
	Appeared->>Detached: IsAppeared
	Initialized->>Detached: IsInitialised
")
```
</div>



### leaf age

The age of leaf cohort is defined as the thermal time after appearance, (i.e. keep zero after initialization). As the default values of `DetachmentLagDuration` and `DetachmentDuration` are set as `1000000` <sup>&deg;</sup>Cd, the cohort age keeps increasing until stage `ReadyForHarvesting`.

<div class="fig-output">
```{r leaf-age, fig.cap='Age of leaf cohort as a function of stage or accumulated thermal time'}
y_cols <- c(
    'Wheat.Leaf.CohortAge')
plot_report_vector(
    df, x_var, y_cols, x_lab = x_lab, 
    y_lab = 'Age of leaf cohort (oCd)')

```
</div>


### Leaf initialization

A new leaf is initialized when the primordia number is increased by 1 at the main stem. Consequently, the total leaf cohort number is equal to total primordia number. The initialized rate of leaf cohort is equal to plastrochron.

<div class="fig-output">

```{r leaf-init-number, fig.cap='The primordia number in the main stem and initialised cohort number'}
y_cols <- c('Wheat.Structure.MainStemPrimordiaNo',
            'Wheat.Leaf.InitialisedCohortNo')

plot_report(df, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Number')

```
</div>



```{block, type='rmdimportant', echo=TRUE}
Actually, the total leaf primordia number is slightly less than the total cohort number.
```


```{block, type='rmdimportant', echo=TRUE}
The plastrochron supposed to 1.1 times of phyllochron. However the slope of Figure \@ref(fig:leaf-init-number)B (plastrochorn) is constant which is contrast with the slope of \@ref(fig:leaf-appear-number)B (phyllochron).   
```


### Leaf appearance 
A new leaf is appeared when the node number is increased by 1 at the main stem. Consequently, the appearance rate of leaf cohort is equal to phyllochron.


<div class="fig-output">

```{r leaf-appear-number, fig.cap='The node number in the main stem and appeared cohort number'}
y_cols <- c('Wheat.Structure.MainStemNodeNo',
            'Wheat.Leaf.AppearedCohortNo')

plot_report(df, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Number')

```
</div>

### Other periods

The lengths of other periods are determined when a new leaf initialized. 

* Growth duration is defined as a phyllochron.
* Lag duration is defined as 4 phyllochrons for leaf appeared during vegetative period (from emergence to terminal spikelet). For leaf cohort apeared during stem alongtation period (from terminal spikelet to flag leaf), the lag duration equals to total length from stage `FlagLeaf` to stage `EndGrainFill` minus 3 phyllochron (`senescence duration`). 

```{block, type='rmdnote', echo=TRUE}
It could be only for flag leaf for extra longer lag duration. Need to check.

```

* Senescence duration is defined as 3 phyllochrons.
* Detachment lag and dutachment duration are set as a big value `1000000` which assumes no detachment in wheat. Actually all leaves are detached at `Harvesting` event.

Figure \@ref(fig:leaf-cohort-number) shows the number of leaf cohort for expanding, initilised, appeared, senescing and dead cohort.

<div class="fig-output">
```{r leaf-cohort-number, fig.asp = 1.4, fig.cap='Initialized, appeared and expanding cohort number'}
y_cols <- c(
            'Wheat.Leaf.ExpandingCohortNo',
            'Wheat.Leaf.InitialisedCohortNo',
            'Wheat.Leaf.AppearedCohortNo',
            'Wheat.Leaf.SenescingCohortNo',
            'Wheat.Leaf.DeadCohortNo')

plot_report(df, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Cohort number')
```
</div>


The totlal leaf number is multiplied by leaf cohort number and stem number (Figure \@ref(fig:leaf-number)).

<div class="fig-output">
```{r leaf-number, fig.asp = 1.3, fig.cap='Appeared number of green, senesced and total leaves'}
y_cols <- c(
    'Wheat.Leaf.PlantAppearedLeafNo',
    'Wheat.Leaf.PlantAppearedGreenLeafNo',
    'Wheat.Leaf.PlantsenescedLeafNo')

plot_report(df, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Leaf number')
```
</div>


The fraction of final leaf is set as 1, but return the actual fraction of the final leaf if the last leaf has appeared. 

<div class="fig-output">
```{r final-leaf-fraction, fig.cap='Fraction of final leaf'}
y_cols <- c(
    'Wheat.Leaf.FinalLeafFraction')

plot_report(df, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Fraction of final leaf')
```
</div>


```{block, type='rmdwarning', echo=TRUE}
Not sure about the main point of final leaf fraction. The fraction is not integer as the final node number  is not an integer.
```


## Leaf area index

Leaf area index (LAI) are calculated for green leaf ($\text{LAI}_{g}$), dead leaf ($\text{LAI}_{d}$), and total leaf ($\text{LAI}_{t}$).

The maximum leaf area of each leaf cohort is determined when leaf cohort is appeared. The profile of maximum leaf area by rank is specified by two paramters the maximum leaf area in all leaves (`AreaLargestLeaves` with default value 2600 mm^2^) and an age factor (Figure \@ref(fig:maximum-area-age)). The age factor is assumed all leaves appeared after stage `Terminal Spikelet` have the same maximum leaf size.

```{block, type='rmdwarning', echo=TRUE}
Actually, in the test simualtion, the maximum leaf area of flag leaf doesn't equal to the parameter `AreaLargestLeaves` as the final leaf fraction is not equal to 1.
```


<div class="fig-input">
```{r maximum-area-age, fig.asp = 0.75, fig.cap='Multiplier of maximum leaf area as a function of growthing stage'}
xpath <- '//Name[text()="AgeFactor"]'
plot_xypair(pmf, xpath, x_lab = 'Growthing stage', y_lab = 'Multiplier of maximum leaf area')

```
</div>


```{block, type="rmpimportant", echo=TRUE}
In the previous version of APSIM-Wheat model,  the x-value of leaf area profile is `RelativeNodeAppearance`. However `RelativeNodeAppearance` is suddently increased at stage `Terminal Spikelet` which is caused by resetting of final node number (Figure \@ref(fig:relative-node-number)). 

TODO: Need to check how leaf cohort model uses the maximum leaf area.
```



<div class="fig-output">
```{r leaf-cohort-max-area, fig.cap='Maximum area of leaf cohort as a function of stage or accumulated thermal time'}
y_cols <- c(
    'Wheat.Leaf.MaxLeafArea')
plot_report_vector(
    df, x_var, y_cols, x_lab = x_lab, 
    y_lab = 'Maximum leaf area (mm2)')

```
</div>




<div class="fig-output">
```{r leaf-lai, fig.cap='Leaf area index'}
y_cols <- c(
    'Wheat.Leaf.LAI', 
'Wheat.Leaf.LAIDead',
'Wheat.Leaf.LAITotal')
plot_report(df, x_var, y_cols, x_lab = x_lab, y_lab = 'Leaf area index')

```
</div>


## Ground coverage

and coverage are calculated for green leaf ($C_g$), dead leaf ($C_d$), and total leaf ($C_t$) from LAI and extinction coefficient for green leaf ($k_{g}$) and dead leaf ($k_{d}$). 

$$
C_{g}=C_{max}(1-\exp(-k_{g}\frac{\text{LAI}_{g}}{C_{max}}))
$$

As the default value of maximum coverage ($C_{max}$) is 1, the function is reduced to
$$
C_{g}=1-\exp(-k_{g}\text{LAI}_{g})
$$

The similar equation is used for dead coverage.

$$
C_{d}=1-\exp(-k_{d}\text{LAI}_{d})
$$

Total coverage ($C_t$) is calculated from coverage of green and dead leaves.
$$
    C_{t} = 1 - (1 - C_{g})(1 - C_{d})
$$

The extinction coefficient for dead leaf ($k_{d}$) is defined as 0.3. The extinction coefficient for green leaf ($k_{g}$) is calculated by parameter `ExtinctionCoeff` which is depending on LAI and water stress.  

In the current version of APSIM-Wheat, extinction coefficient is set as 0.5 without variation as leaf area index. 

```{block, type='rmdnote', echo=TRUE}
Extinction coefficient of dead leaf ($k_{d}$) is not setable in the APSIM User Interface which is defined in the xml file. 
```


<div class="fig-input">
```{r k-lai, fig.asp = 0.75, fig.cap='Extinction coefficient as a function of leaf area index (LAI)'}
xpath <- '//Name[text()="PotentialExtinctionCoeff"]'
plot_xypair(pmf, xpath, x_lab = 'Leaf area index', y_lab = 'Extinction coefficient')

```
</div>

The extinction coefficient of green leaf is adjusted by water stress which is the ratio of water supply and demand. No adjustment is applied to extinction coefficient if water supply is more than water demand. However, extinction coefficient is reduced when water supply is less than water demand (Figure \@ref(fig:k-water-stress), i.e. $k$ = 0.25 when no water supply).

<div class="fig-input">
```{r k-water-stress, fig.asp = 0.75, fig.cap='Multiplier of extinction coefficient as a function of water stress'}
xpath <- '//MultiplyFunction[Name="ExtinctionCoeff"]/LinearInterpolationFunction/Name[text()="WaterStress"]'
plot_xypair(pmf, xpath, x_lab = 'Ratio of water supply and demand', y_lab = 'Extinction coefficient')

```
</div>






<div class="fig-output">
```{r leaf-cover, fig.cap='Coverage'}
y_cols <- c(
    'Wheat.Leaf.CoverGreen',
    'Wheat.Leaf.CoverDead',
    'Wheat.Leaf.CoverTotal')
plot_report(df, x_var, y_cols, x_lab = x_lab, y_lab = 'Coverage')

```
</div>




## Leaf biomass

<div class="fig-output">
```{r leaf-biomass, fig.cap='Leaf biomass'}
y_cols <- c(
    'Wheat.Leaf.LiveWeight', 
'Wheat.Leaf.DeadWeight')
plot_report(df, x_var, y_cols, x_lab = x_lab, y_lab = 'Leaf biomass (g/m2)')

```
</div>



<div class="fig-output">
```{r leaf-specific-leaf-area, fig.cap='Specific leaf area'}
y_cols <- c('Wheat.Leaf.SpecificArea')
plot_report(df, x_var, y_cols, x_lab = x_lab, y_lab = 'Specific leaf area (mm2/g)')

```
</div>


## Frost impact 

Kill a fraction in all leaves ...
